<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Trash Bin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            surface: '#f8fafc',
            card: '#ffffff',
            muted: '#64748b',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .toggle { position: relative; width: 44px; height: 24px; background: #e2e8f0; border-radius: 12px; cursor: pointer; transition: background 0.2s; }
    .toggle.on { background: #3b82f6; }
    .toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .toggle.on::after { transform: translateX(20px); }
    .btn { transition: all 0.15s ease; }
    .btn:active { transform: scale(0.98); }
    .card { transition: box-shadow 0.2s ease; }
    .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    input[type="range"] { -webkit-appearance: none; background: #e2e8f0; border-radius: 4px; height: 6px; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #3b82f6; border-radius: 50%; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  </style>
</head>
<body class="bg-surface text-slate-800 min-h-screen">

<!-- LOGIN -->
<div id="loginScreen" class="flex items-center justify-center min-h-screen px-4">
  <div class="bg-card rounded-2xl p-8 w-full max-w-sm shadow-lg">
    <div class="text-center mb-8">
      <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
      </div>
      <h1 class="text-xl font-semibold text-slate-900">Smart Trash Bin</h1>
      <p class="text-muted text-sm mt-1">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</p>
    </div>
    <input id="pwdInput" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"
      class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4">
    <button onclick="login()" class="btn w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium">
      ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    </button>
    <p id="loginErr" class="text-red-500 text-sm text-center mt-3 hidden"></p>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

  <!-- Header -->
  <header class="bg-card border-b border-slate-100 px-4 py-4 sticky top-0 z-30">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center">
          <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
        </div>
        <div>
          <h1 class="text-lg font-semibold text-slate-900">Smart Trash Bin</h1>
          <div class="flex items-center gap-2">
            <span id="dot" class="w-2 h-2 rounded-full bg-slate-300"></span>
            <span id="dotTxt" class="text-xs text-muted">-</span>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="setAllMode('auto')" class="btn px-3 py-2 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 rounded-lg text-sm font-medium">
          Auto ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </button>
        <button onclick="setAllMode('manual')" class="btn px-3 py-2 bg-amber-50 hover:bg-amber-100 text-amber-700 rounded-lg text-sm font-medium">
          Manual ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </button>
        <button onclick="logout()" class="btn px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-sm">
          ‡∏≠‡∏≠‡∏Å
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-6">

    <!-- Bins -->
    <div id="binCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>

    <!-- Logs -->
    <div class="bg-card rounded-2xl p-5 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-medium text-slate-900">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h2>
        <button onclick="refresh()" class="btn text-sm text-blue-600 hover:text-blue-700 font-medium">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      </div>
      <div id="logList" class="space-y-2 max-h-64 overflow-y-auto"></div>
    </div>
  </main>
</div>

<script>
const API = '/api';
const BIN_ICONS = ['üóëÔ∏è','‚ôªÔ∏è','‚ö†Ô∏è','üåø'];
const ACT_LBL = {
  lid_opened:'‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤', lid_closed:'‡∏õ‡∏¥‡∏î‡∏ù‡∏≤',
  mode_changed:'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î', threshold_changed:'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏∞‡∏¢‡∏∞',
  manual_open:'‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤ (Manual)', manual_close:'‡∏õ‡∏¥‡∏î‡∏ù‡∏≤ (Manual)',
};
let token = localStorage.getItem('token');
let refreshTimer;

async function login(){
  const pwd = document.getElementById('pwdInput').value.trim();
  const err = document.getElementById('loginErr');
  err.classList.add('hidden');
  if(!pwd) return;
  try {
    const r = await fetch(`${API}/auth`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pwd})});
    const d = await r.json();
    if(!r.ok){ err.textContent = d.error||'‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'; err.classList.remove('hidden'); return; }
    token = d.token; localStorage.setItem('token',token);
    showDashboard();
  } catch(e){ err.textContent='‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'; err.classList.remove('hidden'); }
}
document.getElementById('pwdInput').addEventListener('keydown',e=>{ if(e.key==='Enter') login(); });

function logout(){ token=null; localStorage.removeItem('token'); clearInterval(refreshTimer); location.reload(); }

function showDashboard(){
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  refresh();
  refreshTimer = setInterval(refresh, 2000);
}

function authHeaders(){ return {'Content-Type':'application/json','Authorization':'Bearer '+token}; }

async function refresh(){
  try {
    const r = await fetch(`${API}/device`,{headers:authHeaders()});
    if(r.status===401){ logout(); return; }
    const d = await r.json();
    renderBins(d.bins||[]);
    renderLogs(d.logs||[]);
    setConn(true);
  } catch{ setConn(false); }
}

async function apiPost(action, payload){
  await fetch(`${API}/device`,{method:'POST',headers:authHeaders(),body:JSON.stringify({from_app:true,action,payload})});
  refresh();
}

function toggleMode(id, cur){ apiPost('set_mode',{id, mode: cur==='auto'?'manual':'auto'}); }
function setThreshold(id, val){ apiPost('set_threshold',{id, threshold_cm: parseFloat(val)}); }
function manualLid(id, open){ apiPost('manual_lid',{id, open}); }
function setAllMode(m){ apiPost('set_all_mode', m); }

function setConn(ok){
  document.getElementById('dot').className = 'w-2 h-2 rounded-full '+(ok?'bg-emerald-500':'bg-red-400');
  document.getElementById('dotTxt').textContent = ok?'‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß':'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
}

function renderBins(bins){
  const c = document.getElementById('binCards');
  c.innerHTML = bins.map((b,i)=>{
    const icon = BIN_ICONS[i]||'üóëÔ∏è';
    const isOpen = b.lid_status==='open';
    const isMan = b.mode==='manual';
    const manOn = b.manual_open;
    const seen = b.device_last_seen ? (Date.now()-new Date(b.device_last_seen).getTime())/1000 : 9999;
    const online = seen < 10;

    return `
    <div class="card bg-card rounded-2xl p-5 shadow-sm">
      <!-- Header -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <span class="text-2xl">${icon}</span>
          <div>
            <h3 class="font-medium text-slate-900">${b.name}</h3>
            <div class="flex items-center gap-2 mt-0.5">
              <span class="flex items-center gap-1 text-xs ${isOpen?'text-emerald-600':'text-slate-400'}">
                <span class="w-1.5 h-1.5 rounded-full ${isOpen?'bg-emerald-500':'bg-slate-300'}"></span>
                ${isOpen?'‡πÄ‡∏õ‡∏¥‡∏î':'‡∏õ‡∏¥‡∏î'}
              </span>
              <span class="flex items-center gap-1 text-xs ${online?'text-blue-600':'text-slate-400'}">
                <span class="w-1.5 h-1.5 rounded-full ${online?'bg-blue-500':'bg-slate-300'}"></span>
                ${online?'online':'offline'}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Distance -->
      <div class="mb-4 p-3 bg-slate-50 rounded-xl">
        <div class="flex justify-between items-baseline mb-2">
          <span class="text-xs text-muted">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</span>
          <span class="text-lg font-semibold ${b.distance_cm < b.threshold_cm ? 'text-red-500' : 'text-slate-900'}">
            ${b.distance_cm>=999?'‚Äî':b.distance_cm.toFixed(0)}<span class="text-xs font-normal text-muted ml-1">cm</span>
          </span>
        </div>
        <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
          <div class="h-full rounded-full transition-all ${b.distance_cm < b.threshold_cm ? 'bg-red-400' : 'bg-emerald-400'}"
               style="width:${Math.max(5,100-Math.min(100,(b.distance_cm/150)*100))}%"></div>
        </div>
      </div>

      <!-- Mode -->
      <div class="flex items-center justify-between mb-4">
        <div>
          <div class="text-sm font-medium text-slate-700">${isMan?'Manual':'Auto'}</div>
          <div class="text-xs text-muted">‡πÇ‡∏´‡∏°‡∏î</div>
        </div>
        <div class="toggle ${isMan?'on':''}" onclick="toggleMode(${b.id},'${b.mode}')"></div>
      </div>

      <!-- Threshold (Auto only) -->
      <div class="${isMan?'opacity-40 pointer-events-none':''}">
        <div class="flex justify-between text-xs mb-2">
          <span class="text-muted">‡∏£‡∏∞‡∏¢‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö</span>
          <span class="font-medium text-slate-700" id="th${b.id}">${b.threshold_cm} cm</span>
        </div>
        <input type="range" min="10" max="100" step="5" value="${b.threshold_cm}"
          class="w-full cursor-pointer"
          oninput="document.getElementById('th${b.id}').textContent=this.value+' cm'"
          onchange="setThreshold(${b.id},this.value)">
      </div>

      <!-- Manual Buttons -->
      <div class="grid grid-cols-2 gap-2 mt-4 ${!isMan?'opacity-40 pointer-events-none':''}">
        <button onclick="manualLid(${b.id},true)"
          class="btn py-2.5 rounded-xl text-sm font-medium transition
          ${manOn?'bg-emerald-500 text-white':'bg-slate-100 text-slate-600 hover:bg-emerald-500 hover:text-white'}">
          ‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤
        </button>
        <button onclick="manualLid(${b.id},false)"
          class="btn py-2.5 rounded-xl text-sm font-medium transition
          ${!manOn?'bg-slate-700 text-white':'bg-slate-100 text-slate-600 hover:bg-slate-700 hover:text-white'}">
          ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤
        </button>
      </div>
    </div>`;
  }).join('');
}

function renderLogs(logs){
  const c = document.getElementById('logList');
  if(!logs.length){ c.innerHTML='<p class="text-muted text-sm text-center py-6">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>'; return; }
  c.innerHTML = logs.map(l=>{
    const t = new Date(l.created_at).toLocaleString('th-TH',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'short'});
    const lbl = ACT_LBL[l.action]||l.action;
    return `
    <div class="flex items-center justify-between py-2 px-3 bg-slate-50 rounded-lg">
      <div class="flex items-center gap-3">
        <span class="text-sm text-slate-700">${lbl}</span>
        <span class="text-xs text-muted">‡∏ñ‡∏±‡∏á #${l.bin_id}</span>
        ${l.detail?`<span class="text-xs text-slate-400">${l.detail}</span>`:''}
      </div>
      <span class="text-xs text-muted">${t}</span>
    </div>`;
  }).join('');
}

if(token) showDashboard();
</script>
</body>
</html>